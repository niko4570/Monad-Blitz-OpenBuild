<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤šäººæ·éª°å­æ¸¸æˆ</title>
</head>
<body>
  <h1>ğŸ² å¤šäººæ·éª°å­æ¸¸æˆ</h1>

  <!-- é’±åŒ…è¿æ¥ -->
  <button id="connectWallet">è¿æ¥ MetaMask</button>
  <p id="walletAddress"></p>

  <hr/>

  <!-- åˆ›å»ºæˆ¿é—´ -->
  <h2>åˆ›å»ºæˆ¿é—´</h2>
  <input type="number" id="maxPlayers" value="1" min="1">
  <button id="createRoomBtn">åˆ›å»ºæˆ¿é—´</button>
  <p id="createdRoomId"></p>

  <!-- åŠ å…¥æˆ¿é—´ -->
  <h2>åŠ å…¥æˆ¿é—´</h2>
  <input type="text" id="joinRoomId" placeholder="æˆ¿é—´å·">
  <button id="joinRoomBtn">åŠ å…¥æˆ¿é—´</button>

  <!-- åˆ é™¤æˆ¿é—´ -->
  <h2>åˆ é™¤æˆ¿é—´</h2>
  <input type="text" id="deleteRoomId" placeholder="æˆ¿é—´å·">
  <button id="deleteRoomBtn">åˆ é™¤æˆ¿é—´</button>

  <!-- æŸ¥è¯¢èµ¢å®¶ -->
  <h2>æŸ¥è¯¢èµ¢å®¶</h2>
  <input type="text" id="checkRoomId" placeholder="æˆ¿é—´å·">
  <button id="checkWinnerBtn">æŸ¥çœ‹èµ¢å®¶</button>
  <p id="winner"></p>

  <!-- å¼•å…¥ ethers.js UMD ç‰ˆæœ¬ -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.15.0/dist/ethers.umd.min.js"></script>

  <script>
  window.addEventListener("load", () => {
    const CONTRACT_ADDRESS = "0x5Cf84Ad10D2ecb4BD0303BA1d3715a4A13BFeB3c"; // TODO: æ›¿æ¢æˆä½ çš„åˆçº¦åœ°å€
    const ABI = [
      {
        "inputs":[{"internalType":"uint256","name":"_maxPlayers","type":"uint256"}],
        "name":"createRoom",
        "outputs":[{"internalType":"uint256","name":"","type":"uint256"}],
        "stateMutability":"nonpayable",
        "type":"function"
      },
      {
        "inputs":[{"internalType":"uint256","name":"roomId","type":"uint256"}],
        "name":"joinRoom",
        "outputs":[],
        "stateMutability":"nonpayable",
        "type":"function"
      },
      ,
      {
        "inputs":[{"internalType":"uint256","name":"roomId","type":"uint256"}],
        "name":"deleteRoom",
        "outputs":[],
        "stateMutability":"nonpayable",
        "type":"function"
      },
      {
        "inputs":[{"internalType":"uint256","name":"roomId","type":"uint256"}],
        "name":"getWinner",
        "outputs":[{"internalType":"address","name":"","type":"address"}],
        "stateMutability":"view",
        "type":"function"
      }
    ];

    let provider, signer, contract;

    // æ‰‹åŠ¨è¿æ¥é’±åŒ…
    document.getElementById("connectWallet").onclick = async () => {
      if (!window.ethereum) {
        alert("MetaMask æœªå®‰è£…æˆ–æœªå¯ç”¨");
        return;
      }
      try {
        const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
        const account = accounts[0];
        document.getElementById("walletAddress").innerText = "å·²è¿æ¥: " + account;

        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

        console.log("é’±åŒ…è¿æ¥æˆåŠŸ:", account);

        const network = await provider.getNetwork();
        console.log("å½“å‰ç½‘ç»œ:", network);
      } catch(err) {
        console.error("è¿æ¥é’±åŒ…å¤±è´¥:", err);
        alert("è¿æ¥é’±åŒ…å¤±è´¥");
      }
    };

    // åˆ›å»ºæˆ¿é—´
    document.getElementById("createRoomBtn").onclick = async () => {
      if (!contract) { 
        alert("è¯·å…ˆè¿æ¥é’±åŒ…"); 
        return; 
      }

      const maxPlayers = parseInt(document.getElementById("maxPlayers").value);
      if (isNaN(maxPlayers) || maxPlayers < 1) {
        alert("è¯·è¾“å…¥åˆæ³•çš„ç©å®¶äººæ•°ï¼ˆè‡³å°‘ 1 äººï¼‰");
        return;
      }

      try {

      provider = new ethers.BrowserProvider(window.ethereum);
      signer = await provider.getSigner();
      contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
      // è°ƒç”¨åˆçº¦ createRoom
      const tx = await contract.createRoom(maxPlayers);
      /*const receipt = await tx.wait();

      const event = receipt.logs
      .map(log => {
        try {
        return contract.interface.parseLog(log);
      } catch(e) {
        return null;
      }
      })
      .find(parsed => parsed && parsed.name === "RoomCreated");

      if (event) {
        const roomId = event.args.roomId;
        alert(`ğŸ‰ åˆ›å»ºæˆ¿é—´æˆåŠŸï¼æˆ¿é—´å·ï¼š${roomId}`);
      } else {
        alert("åˆ›å»ºæˆ¿é—´æˆåŠŸï¼Œä½†æœªæ•è·åˆ° RoomCreated äº‹ä»¶");
      }*/

      const receipt = await tx.wait(); // ç­‰å¾…äº¤æ˜“ä¸Šé“¾
      
      const roomCreatedEvent = receipt.logs
      .map(log => {
      try {
        return contract.interface.parseLog(log);
      } catch (e) {
        return null;
      }
      })
      .find(e => e && e.name === "RoomCreated");

      if (roomCreatedEvent) {
        const roomId = roomCreatedEvent.args.roomId;
        alert(`ğŸ‰ åˆ›å»ºæˆ¿é—´æˆåŠŸï¼æˆ¿é—´å·ï¼š${roomId}`);
      } else {
        alert("åˆ›å»ºæˆ¿é—´æˆåŠŸï¼Œä½†æœªæ•è·åˆ° RoomCreated äº‹ä»¶");
      }
      /*
      // ç”¨ callStatic è·å–è¿”å›å€¼ï¼ˆæˆ¿é—´å·ï¼‰
      const roomId = await contract.callStatic.createRoom(maxPlayers);
      alert(`ğŸ‰ åˆ›å»ºæˆ¿é—´æˆåŠŸï¼æˆ¿é—´å·ï¼š${roomId}`);
      */

      } catch(err) {
        console.error(err);
        alert("åˆ›å»ºæˆ¿é—´å¤±è´¥ï¼š" + (err?.message || err));
      }
    };

    // åŠ å…¥æˆ¿é—´
    document.getElementById("joinRoomBtn").onclick = async () => {
      if (!contract) { alert("è¯·å…ˆè¿æ¥é’±åŒ…"); return; }
      const roomId = document.getElementById("joinRoomId").value;
      try {
        const tx = await contract.joinRoom(roomId);
        await tx.wait();
        alert("åŠ å…¥æˆ¿é—´æˆåŠŸï¼Œç­‰å¾…äººæ•°æ»¡è‡ªåŠ¨å¼€å§‹æ¸¸æˆ");
      } catch(err) {
        console.error(err);
        alert("åŠ å…¥æˆ¿é—´å¤±è´¥");
      }
    };

    // åˆ é™¤æˆ¿é—´
    document.getElementById("deleteRoomBtn").onclick = async () => {
      if (!contract) { alert("è¯·å…ˆè¿æ¥é’±åŒ…"); return; }
      const roomId = document.getElementById("deleteRoomId").value;
      try {
        const tx = await contract.deleteRoom(roomId);
        await tx.wait();
        alert("åˆ é™¤æˆ¿é—´æˆåŠŸ");
      } catch(err) {
        console.error(err);
        alert("åˆ é™¤æˆ¿é—´å¤±è´¥");
      }
    };

    // æŸ¥è¯¢èµ¢å®¶
    document.getElementById("checkWinnerBtn").onclick = async () => {
      if (!contract) { alert("è¯·å…ˆè¿æ¥é’±åŒ…"); return; }
      const roomId = document.getElementById("checkRoomId").value;
      try {
        const winnerAddr = await contract.getWinner(roomId);
        document.getElementById("winner").innerText = winnerAddr === "0x0000000000000000000000000000000000000000" 
          ? roomId + "æˆ¿é—´æ¸¸æˆè¿˜æœªç»“æŸæˆ–æ— äººè·èƒœï¼š" + winnerAddr
          : "ğŸ† è·èƒœè€…ï¼š" + winnerAddr;
      } catch(err) {
        console.error(err);
        alert("æŸ¥è¯¢å¤±è´¥");
      }
    };
  });
  </script>
</body>
</html>

